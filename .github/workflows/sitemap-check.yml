name: Sitemap Monitor

on:
  push:
    branches: [ main ]
    paths:
      - 'main.py'
      - 'config.yaml'
      - '*.py'
      - 'requirements.txt'
      - '.github/workflows/sitemap-check.yml'
  schedule:
    - cron: '0 22 * * *'  # UTC 22:00ï¼ˆåŒ—äº¬æ—¶é—´æ¬¡æ—¥ 06:00ï¼‰
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Monitor
        run: python main.py

      - name: Commit changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          # åªæäº¤ç›‘æ§äº§ç‰©ï¼Œé¿å…æŠŠæ— å…³æ–‡ä»¶è¯¯æäº¤
          git add diff latest config.yaml || true

          # æ²¡å˜åŒ–åˆ™é€€å‡ºï¼ˆä¸åˆ· commitï¼‰
          git diff --quiet && git diff --staged --quiet && echo "No changes to commit." && exit 0

          git commit -m "ğŸ“¦ Update sitemap data: $(date +'%Y-%m-%d')"
          git push

      - name: Notify Feishu (only when diff changes)
        env:
          FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
        run: |
          python - << 'PY'
          import os, glob, json
          from urllib.request import Request, urlopen

          webhook = os.getenv("FEISHU_WEBHOOK")
          if not webhook:
            raise SystemExit("Missing FEISHU_WEBHOOK secret")

          # æ‰¾æœ€æ–° diff ç›®å½•ï¼ˆä¾‹å¦‚ diff/20251216ï¼‰
          diff_dirs = sorted(glob.glob("diff/*"))
          if not diff_dirs:
            print("No diff directories found, skip notify.")
            raise SystemExit(0)

          latest_dir = diff_dirs[-1]

          def read_lines(path):
            try:
              with open(path, "r", encoding="utf-8") as f:
                return [x.strip() for x in f.read().splitlines() if x.strip()]
            except FileNotFoundError:
              return []

          added = read_lines(os.path.join(latest_dir, "added.txt"))
          removed = read_lines(os.path.join(latest_dir, "removed.txt"))

          # æ²¡å˜åŒ–å°±ä¸æ¨ï¼ˆé¿å…åˆ·å±ï¼‰
          if not added and not removed:
            print("No added/removed URLs, skip notify.")
            raise SystemExit(0)

          # æ§åˆ¶æ¶ˆæ¯é•¿åº¦ï¼šæœ€å¤šå±•ç¤ºå‰ 20 æ¡
          def fmt_list(lst, limit=20):
            show = lst[:limit]
            more = len(lst) - len(show)
            lines = "\n".join([f"- {u}" for u in show])
            if more > 0:
              lines += f"\n... è¿˜æœ‰ {more} æ¡æœªå±•ç¤º"
            return lines

          title = f"ğŸ§­ Sitemap å˜æ›´ï¼ˆ{os.path.basename(latest_dir)}ï¼‰"
          parts = []
          if added:
            parts.append(f"âœ… æ–°å¢ {len(added)} æ¡\n{fmt_list(added)}")
          if removed:
            parts.append(f"âŒ åˆ é™¤ {len(removed)} æ¡\n{fmt_list(removed)}")

          text = title + "\n\n" + "\n\n".join(parts)

          payload = {"msg_type": "text", "content": {"text": text}}
          req = Request(webhook, data=json.dumps(payload).encode("utf-8"),
                        headers={"Content-Type": "application/json"}, method="POST")
          with urlopen(req) as resp:
            print(resp.read().decode("utf-8"))
          PY

